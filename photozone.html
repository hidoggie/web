<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR í¬í† ì¡´</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }
        #ar-container { width: 100%; height: 100%; position: relative; }
        
        model-viewer {
            width: 100%;
            height: 80vh;
            --ar-button-vertical-align: bottom;
            --ar-button-horizontal-align: left;
            --ar-button-margin: 20px;
        }

        #ar-prompt {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2em;
        }

        #model-selection-bar {
            position: fixed; bottom: 90px; left: 0;
            width: 100%; padding: 10px 0;
            display: flex; justify-content: center;
            gap: 10px; z-index: 10;
            box-sizing: border-box; overflow-x: auto;
        }
        .model-thumbnail {
            width: 60px; height: 60px; object-fit: cover;
            border-radius: 8px; cursor: pointer; border: 2px solid transparent;
        }
        .model-thumbnail.selected { border-color: #007bff;  border: 2px solid;
        }

        
        /* ì…”í„° ë° ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ UI */
        .overlay-ui { position: fixed; width: 100%; z-index: 10; box-sizing: border-box; }
        .top-bar { top: 0; display: flex; justify-content: space-between; padding: 20px; }
        .bottom-bar { bottom: 0; display: flex; justify-content: space-between; padding: 20px; }
        .ui-button { width: 7.5rem; padding: 10px 10px; font-size: 1em; border-radius: 5px; border: none; background-color: rgba(0,0,0,0.6); color: white; cursor: pointer; }
        #capture-btn { width: 4rem; height: 4rem; border-radius: 50%; background-color: white; border: 5px solid rgba(0, 0, 0, 0.5); }
        .hidden { display: none; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    </style>
    
</head>
<body>

<div id="ar-container">
    <model-viewer
        id="planet-viewer"
      style="background-color: #E8E8E8"
      interaction-prompt="auto"
      auto-rotate
      autoplay
      ar
      ar-modes="scene-viewer webxr"
      magic-leap
      quick-look-browsers="safari chrome"
      shadow-intensity="2"
      environment-image="neutral"
      ar-scale="0.25"
      camera-controls
      touch-action="pan-y"
      camera-target="0m -1.1m 0m"
      camera-orbit="-30deg auto auto"
      max-camera-orbit="auto 100deg auto"
      alt="AR 3D ëª¨ë¸">        
    </model-viewer>
    <div id="ar-prompt" slot="ar-button">ARì„ ì‹œì‘í•˜ë ¤ë©´ ì£¼ë³€ ë°”ë‹¥ì„ ë¹„ì¶°ì£¼ì„¸ìš”</div>
</div>

<!--div class="overlay top-bar">
    <button id="map-btn" class="ui-button">ğŸ—ºï¸ í–‰ì„± ì§€ë„</button>
    <button id="close-btn" class="ui-button">âŒ ë‹«ê¸°</button>
</div-->

<div id="model-selection-bar"></div>
<div class="overlay-ui bottom-bar">
        <button id="map-btn" class="ui-button">ğŸ—ºï¸ í–‰ì„± ì§€ë„</button>
        <button id="capture-btn"></button>
        <button id="close-btn" class="ui-button">âŒ ë‹«ê¸°</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const modelViewer = document.getElementById('planet-viewer');
        const modelSelectionBar = document.getElementById('model-selection-bar');
        const captureBtn = document.getElementById('capture-btn');
        const mapBtn = document.getElementById('map-btn');
        const closeBtn = document.getElementById('close-btn');

        let pressTimer = null;
        let isRecording = false;
        let mediaRecorder = null;
        let recordedChunks = [];
        
        // --- 1. í–‰ì„±ë³„ë¡œ ì—°ê´€ëœ ëª¨ë¸ ëª©ë¡ì„ ì •ì˜ ---
        const planetRelatedModels = {
            earth: [
                { id: 'earth_globe', name: 'ì§€êµ¬ë³¸', thumbnail: './images/earth_thumb.png', path: './models/saturn_planet.glb', iosPath: './models/earth_globe.usdz', scale: '0.5 0.5 0.5' },
                { id: 'space_station', name: 'ìš°ì£¼ì •ê±°ì¥', thumbnail: './images/mars_thumb.png', path: './models/jupiter_planet.glb', iosPath: './models/earth_globe.usdz', scale: '0.2 0.2 0.2' },
            ],
            mars: [
                { id: 'mars_rover', name: 'íƒì‚¬ ë¡œë²„', thumbnail: './images/rover_thumb.png', path: './models/rover.glb', iosPath: './models/earth_globe.usdz', scale: '0.4 0.4 0.4' },
                { id: 'mars_planet', name: 'í™”ì„±', thumbnail: './images/mars_thumb.png', path: './models/mars.glb', iosPath: './models/earth_globe.usdz', scale: '0.5 0.5 0.5' },
            ],
            jupiter: [
                { id: 'earth_globe', name: 'ì§€êµ¬ë³¸', thumbnail: './images/earth_globe_thumb.png', path: '/static/assets/models/earth_globe.glb', iosPath: './models/earth_globe.usdz', scale: '0.5 0.5 0.5' },
                { id: 'space_station', name: 'ìš°ì£¼ì •ê±°ì¥', thumbnail: './images/iss_thumb.png', path: '/static/assets/models/iss.glb', iosPath: './models/earth_globe.usdz', scale: '0.2 0.2 0.2' },
            ],
            saturn: [
                { id: 'mars_rover', name: 'íƒì‚¬ ë¡œë²„', thumbnail: './images/rover_thumb.png', path: '/static/assets/models/rover.glb', iosPath: './models/earth_globe.usdz', scale: '0.4 0.4 0.4' },
                { id: 'mars_planet', name: 'í™”ì„±', thumbnail: './images/mars_thumb.png', path: '/static/assets/models/mars.glb', iosPath: './models/earth_globe.usdz', scale: '0.5 0.5 0.5' },
            ],
            uranus: [
                { id: 'earth_globe', name: 'ì§€êµ¬ë³¸', thumbnail: './images/earth_globe_thumb.png', path: '/static/assets/models/earth_globe.glb', iosPath: './models/earth_globe.usdz', scale: '0.5 0.5 0.5' },
                { id: 'space_station', name: 'ìš°ì£¼ì •ê±°ì¥', thumbnail: './images/iss_thumb.png', path: '/static/assets/models/iss.glb', iosPath: './models/earth_globe.usdz', scale: '0.2 0.2 0.2' },
            ],
            neptune: [
                { id: 'mars_rover', name: 'íƒì‚¬ ë¡œë²„', thumbnail: './images/rover_thumb.png', path: '/static/assets/models/rover.glb', iosPath: './models/earth_globe.usdz', scale: '0.4 0.4 0.4' },
                { id: 'mars_planet', name: 'í™”ì„±', thumbnail: './images/mars_thumb.png', path: '/static/assets/models/mars.glb', iosPath: './models/earth_globe.usdz', scale: '0.5 0.5 0.5' },
            ],
            // ... ë‹¤ë¥¸ í–‰ì„±ë“¤ì˜ ëª¨ë¸ ëª©ë¡ë„ ë™ì¼í•˜ê²Œ ì •ì˜ ...
        };

        // --- 2. í˜ì´ì§€ ì´ˆê¸°í™” ---
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            // URLì—ì„œ 'planet' íŒŒë¼ë¯¸í„°ë¥¼ ì½ì–´ì˜¤ê³ , ì—†ìœ¼ë©´ 'earth'ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©
            const planetId = urlParams.get('planet') || 'earth';
            const modelsToShow = planetRelatedModels[planetId];

            if (!modelsToShow) {
                alert("í•´ë‹¹ í–‰ì„±ì˜ ëª¨ë¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            
            initModelSelectionBar(modelsToShow);
        }

        // --- 3. ëª¨ë¸ ì„ íƒ ë°”ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ ---
        function initModelSelectionBar(models) {
            modelSelectionBar.innerHTML = '';
            models.forEach((model, index) => {
                const img = document.createElement('img');
                img.src = model.thumbnail;
                img.alt = model.name;
                img.classList.add('model-thumbnail');
                
                img.addEventListener('click', () => {
                    document.querySelectorAll('.model-thumbnail').forEach(thumb => thumb.classList.remove('selected'));
                    img.classList.add('selected');
                    // model-viewerì˜ srcì™€ scale ì†ì„±ì„ ë™ì ìœ¼ë¡œ ë³€ê²½
                    modelViewer.src = model.path;
                    modelViewer.setAttribute('poster', model.thumbnail);
                    modelViewer.setAttribute('ios-src', model.iosPath);
                    modelViewer.setAttribute('scale', model.scale);
                });
                modelSelectionBar.appendChild(img);
                
                // ì²« ë²ˆì§¸ ëª¨ë¸ì„ ê¸°ë³¸ìœ¼ë¡œ ë¡œë“œ
                if (index === 0) {
                    img.classList.add('selected');
                    modelViewer.src = model.path;
                    modelViewer.setAttribute('poster', model.thumbnail);
                    modelViewer.setAttribute('ios-src', model.iosPath);
                    modelViewer.setAttribute('scale', model.scale);
                }
            });
        }

        // AR ëª¨ë“œê°€ í™œì„±í™”ë˜ë©´ ìë™ìœ¼ë¡œ AR ë²„íŠ¼ í´ë¦­ (ì‚¬ìš©ì í¸ì˜)
//        modelViewer.addEventListener('load', () => {
            // 3D ëª¨ë¸ ë¡œë“œê°€ ì™„ë£Œë˜ë©´, AR ëª¨ë“œë¥¼ ì§ì ‘ í™œì„±í™”í•©ë‹ˆë‹¤.
//            modelViewer.activateAR();
//        });

        // --- 1. ì‚¬ì§„ ì´¬ì˜ í•¨ìˆ˜ (model-viewer ë‚´ì¥ ê¸°ëŠ¥ ì‚¬ìš©) ---
        async function takePicture() {
            try {
                const blob = await modelViewer.toBlob({mimeType: 'image/png'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ar_photo_${new Date().getTime()}.png`;
                a.click();
                URL.revokeObjectURL(url);
            } catch(e) {
                alert("ì‚¬ì§„ ìº¡ì²˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + e.message);
            }
        }

        // --- 2. ë™ì˜ìƒ ë…¹í™” í•¨ìˆ˜ (ë¸Œë¼ìš°ì € í™”ë©´ ë…¹í™” ê¸°ëŠ¥ ì‚¬ìš©) ---
        async function startRecording() {
            console.log("ë…¹í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...");
            isRecording = true;
            captureBtn.style.border = '5px solid red'; // ë…¹í™” ì¤‘ì„ì„ ì‹œê°ì ìœ¼ë¡œ í‘œì‹œ

            try {
                // í˜„ì¬ í™”ë©´ì„ ë…¹í™” ëŒ€ìƒìœ¼ë¡œ ì§€ì •
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { mediaSource: "screen" }
                });
                
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) recordedChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ar_video_${new Date().getTime()}.webm`;
                    a.click();
                    URL.revokeObjectURL(url);
                    recordedChunks = [];
                    // ìŠ¤íŠ¸ë¦¼ íŠ¸ë™ ì¤‘ì§€
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
            } catch (e) {
                console.error("ë…¹í™” ì‹œì‘ ì˜¤ë¥˜:", e);
                alert("í™”ë©´ ë…¹í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì˜ í™”ë©´ ê³µìœ /ë…¹í™” ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                stopRecording(); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ìƒíƒœ ì´ˆê¸°í™”
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
            }
            isRecording = false;
            captureBtn.style.border = '5px solid rgba(0, 0, 0, 0.5)';
            console.log("ë…¹í™”ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤.");
        }
        
        // --- 3. ìº¡ì²˜ ë²„íŠ¼ ì´ë²¤íŠ¸ (ì§§ê²Œ/ê¸¸ê²Œ ëˆ„ë¥´ê¸° êµ¬ë¶„) ---
        captureBtn.addEventListener('mousedown', () => {
            pressTimer = setTimeout(() => {
                startRecording();
            }, 500); // 0.5ì´ˆ ì´ìƒ ëˆ„ë¥´ë©´ ë…¹í™”ë¡œ ê°„ì£¼
        });

        // --- 4. ìº¡ì²˜ ë° ë„¤ë¹„ê²Œì´ì…˜ ë¡œì§ ---
        captureBtn.addEventListener('mouseup', () => {
            clearTimeout(pressTimer); // íƒ€ì´ë¨¸ ì·¨ì†Œ
            if (isRecording) {
                stopRecording();
            } else {
                takePicture();
            }
        });
        
        // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ ì§€ì›
        captureBtn.addEventListener('touchstart', (e) => { e.preventDefault(); captureBtn.dispatchEvent(new MouseEvent('mousedown')); });
        captureBtn.addEventListener('touchend', (e) => { e.preventDefault(); captureBtn.dispatchEvent(new MouseEvent('mouseup')); });

        mapBtn.onclick = () => window.location.href = './joayong-map.html';
        closeBtn.onclick = () => window.close();

        // í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘
        init();
    });
</script>
</body>

</html>

