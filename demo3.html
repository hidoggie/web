<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>AR 거북선</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />

    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <script src="./js/aframe120.js"></script>
    
    <script src="./js/aframe-ar-nft-3.js"></script>
    <!--script src="./js/gridhelper.js"></script-->
    <script src="./js/aframe-extra-611.js"></script>
    
    <script src="./js/aframe-chromakey.js"></script>
    <!--script src="./js/grid-selector.js"></script-->
    <script src="./js/aframe-gif-shader.js"></script>
    <script src="./js/aframe-troika-text.js"></script>
    <!--script src="./js/model-opacity.js"></script-->
    <script src="./js/aframe-light-control.js"></script>

    <link rel="stylesheet" href="./css/ocean-safe.css" />
    <ink rel="stylesheet" href="ocean-geobuk.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
      integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script>
        function setScreenHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        window.addEventListener('resize', setScreenHeight);
        setScreenHeight(); // 최초 실행
    </script>

    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: calc(var(--vh, 1vh) * 100);
            overflow: hidden; /* 불필요한 스크롤바 방지 */
        }

        a-scene {
            width: 100%;
            height: calc(var(--vh, 1vh) * 100);
        }

        #ar-view { width: 100%; height: calc(var(--vh, 1vh) * 100); }

    </style>
  </head>
  
  <body style="margin: 0px; overflow: hidden">

    <input
      id="start_btn"
      type="image"
      alt="시작 버튼"
      src="./image/back-clock.gif"
      style="
        position: absolute;
        z-index: 999999;
        display: none;
        top: 15%;
        left: 35%;
        justify-content: center;
        align-items: center;
        height: 30vw;
        width: 30vw;
      "
    />
    <button
           class="HomeButton"
           id="home-btn"
           aria-label="홈 버튼"
           onclick="window.open('https://guide1.ivyro.net/oceanbreeze','_self');"
    ></button>
      
    <button
           class="VidStopBtn"
           id="vstopbtn"
           aria-label="비디오 중지 버튼"
           onclick="vidstop();"
    ></button>
    <button
           class="VidStartBtn"
           id="vstartbtn"
           aria-label="비디오 시작 버튼"
           onclick="vidstart();"
    ></button>

        <button
           aria-label="도슨트 맵 버튼"
           class="DocentMapButton"
           id="docentmap-btn"
           onclick="window.open('https://guide1.ivyro.net/oceanbreeze/AR/docent-map.html','_self');"
        ></button>

    <div id="ar-view">    
    <a-scene
            id="scene"
            loading-screen="dotsColor: white; backgroundColor: #24CAFF; enabled: false;"
            vr-mode-ui="enabled: false"
            arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
            renderer="logarithmicDepthBuffer: true"
            emitevents="true" 
            cursor="rayOrigin: mouse"
            raycaster="objects: #Msg-txt"
    >
      <a-assets>
        <img
          id="groundTexture"
          src="./image/transparent.png"
          alt="배경이미지"
        />
        <a-asset-item
          id="selectorglb"
          src="./3D/pavil.glb"
        ></a-asset-item>
        <!--a-asset-item
          id="Msgglb"
          src="./3D/reticle_white1.glb"
        ></a-asset-item-->
        <a-asset-item
          id="Msgglb"
          src="./image/gate_100.jpg"
        ></a-asset-item>
        <a-asset-item
          id="selector2glb"
          src="./3D/uijangbongjiheukdallyeong.glb"
        ></a-asset-item>
        <video
          src="./MP4/ujungboo_jungboondang.mp4"
          type="video/mp4"
          preload="auto"
          id="vid"
          response-type="arraybuffer"
          crossorigin="anonymous"
          webkit-playsinline     
          playsinline
        ></video>
      </a-assets>

      <!--a-cylinder
        id="ground"
        class="collidable"
        src="#groundTexture"
        radius="82"
        height="0.3"
        position="0 0 -1"
        shadow="cast: true"
        show-entity="image: #selector; text: #Msg-txt; text2: #Msg-txt2; text1: #Msg-txt1; image1: #selector2; image2: #selector3;"
        selective-click
    -->
        <a-entity
          id="Msg-txt"
          visible="true"
          gltf-model="#Msgglb"
          scale="5 5 5"
          position="0 0.7 -5"
          rotation="0 0 0"
          shadow="cast: true"
          animation="property: rotation; to: 0 360 0; dur: 8000; delay: 200; loop: true"
          animation-mixer
          audiohandler
          selective-click
        ></a-entity>
        <a-entity
          id="selector"
          gltf-model="#selectorglb"
          scale="1 1 1"
          rotation="0 0 0"
          position="0.3 0.2 -8"
          visible="false"
          shadow="cast: true"
          animation__click="property: visible; dur: 0; to: true; startEvents: switch"
          animation__rotation="property: rotation; to: 0 360 0; dur: 30000; delay: 200; loop: true"
          animation-mixer
          selective-click
        ></a-entity>

        <a-troika-text
          id="Msg-txt2"
          visible="true"
          position="0 1.5 -3"
          color="white"
          max-width="13"
          max-height="50"
          curve-radius="0"
          scale="0.5 0.5 0.5"
          font="./font/Pretendard-ExtraBold.otf"
          value="        
            바닥을 터치하면
AR 의정부에 대해 안내합니다."
          align="center"
          selective-click
        >
        </a-troika-text>
        <a-troika-text
          id="Msg-txt1"
          visible="true"
          position="0 2 -0.5"
          color="red"
          max-width="13"
          max-height="50"
          curve-radius="0"
          scale="0.5 0.5 0.5"
          font="./font/white-cloud.ttf"
          value="        
AR 의정부 보기"
          align="center"
          selective-click
        >
        </a-troika-text>
        <a-video
          id="selector2"
          geometry="primitive: plane; height: 1.4; width: 3.2"
          material="shader: chromakey; side: double; src: #vid; color: 0.1 0.9 0.2"
          position="0 2.2 -2.4"
          rotation="0 0 0"
          visible="false"
          selective-click
        >
        </a-video>
        <a-entity
          id="selector3"
          gltf-model="#selector2glb"
          scale="1 1 1"
          rotation="0 0 0"
          position="-2 0 -5"
          shadow="cast: true"
          visible="false"
          animation__click="property: visible; dur: 0; to: true; startEvents: switch"
          animation-mixer
          selective-click
        ></a-entity>
      <!--/a-cylinder-->


      <!--a-entity id="rig">
        <a-camera position="0 1.4 0" look-controls="enabled: false">
          <a-entity raycaster="objects: .collidable" cursor="rayOrigin: mouse">
          </a-entity>
        </a-camera>
      </a-entity-->
      
      <a-entity movement-controls="fly: true">
        <a-entity cursor="rayOrigin: mouse" raycaster="objects: #Msg-txt" position="0 1.6 0" camera look-controls="touchEnabled: false; mouseEnabled: false" wasd-controls>
        </a-entity>
      </a-entity>    

      <a-light type="ambient" intensity="0.7" castshadow="false"></a-light>
      <a-shadow-light
        type="spot"
        far="18"
        target="0 10 5"
        mapsize="4096 4096"
        position="0 10 5"
      >
      </a-shadow-light>
      <a-shadow-plane dimensions="10 10" position="0 0 -5"> </a-shadow-plane>
      <!-- Camera. -->
    </a-scene>    
  </div>
    <script src="./js/ocean-geobuk.js"></script>
    <script>
        const sceneEl = document.querySelector('a-scene');
        const Selector = document.getElementById('selector');
        const Selector2 = document.getElementById('selector2');
        const Selector3 = document.getElementById('selector3');
        const Trigger = document.getElementById('Msg-txt');
        const Text1 = document.getElementById('Msg-txt1');
        const Text2 = document.getElementById('Msg-txt2');

    document.addEventListener('DOMContentLoaded', () => {
        sceneEl.addEventListener('loaded', () => {
        // 'mousedown' (PC 클릭)과 'touchstart' (모바일 터치) 이벤트를 감지합니다.
        // { passive: false } 옵션을 여기서 직접 설정합니다.
          sceneEl.canvas.addEventListener('mousedown', onSceneClick, { passive: false });
          sceneEl.canvas.addEventListener('touchstart', onSceneClick, { passive: false });
        });
    })
        // ✨ 3. 클릭/터치 시 실행될 새로운 함수
    function onSceneClick(event) {

        event.stopPropagation();
        event.preventDefault();
        
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // 클릭한 화면 좌표를 3D 공간 좌표로 변환합니다.
        if (event.type === 'touchstart') {
            mouse.x = (event.touches[0].clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.touches[0].clientY / window.innerHeight) * 2 + 1;
        } else {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
        }
    
    }

    AFRAME.registerComponent('selective-click', {
        init: function () {
           this.el.addEventListener('click', (evt) => {
            if (this.el.id === 'Msg-txt') {
              Selector.setAttribute("visible", "true");
              Selector2.setAttribute("visible", "true");
              Selector3.setAttribute("visible", "true");

              Trigger.setAttribute("visible", "false");
              Text1.setAttribute("visible", "false");
              Text2.setAttribute("visible", "false");
            } else {
        // 아무 반응 없음
             evt.stopPropagation();
             evt.preventDefault();
            }
        });
      }
    });
 
    </script>
 </body>
</html>
