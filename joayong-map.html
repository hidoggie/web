<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스탬프 투어 - 행성 여행</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=eb9mai2ikc&callback=initMap"></script>

    <script>
        function setScreenHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        window.addEventListener('resize', setScreenHeight);
        setScreenHeight(); // 최초 실행
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body { 
            height: calc(var(--vh, 1vh) * 100); 
            margin: 0; 
            padding: 0; 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            background-color: #111827;
            color: #ffffff;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: hidden;

        }
        #map { 
            height: calc(var(--vh, 1vh) * 65); 
            margin: 0; 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            background-color: #111827;
            color: #ffffff;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: hidden;
            border: 1px solid #4b5563;
            overflow: hidden;
            padding: 16px; 
            border-radius: 12px;
        }
        #modal, #status-modal { display: none; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 9999; width: 80vw; height: calc(var(--vh, 1vh) * 40);; max-width: 220px;}
        .modal-content { width: 100%; position: absolute; background-color: #1f2937; margin: auto; padding: 15px; border-radius: 10px; text-align: center; grid-template-columns: 1fr; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 15px; width: 100%; }
        .modal-buttons button { height: 4em; padding: 10px 20px; font-size: 1em; cursor: pointer; border-radius: 5px; border: none; color: white; margin-bottom: 15px; }
        .btn-stamp { background-color: #007bff; width: 100%;}
        .btn-photo { background-color: #28a745; width: 100%;}

        .gm-style-iw-c button {
            display: none !important;
        }
        .gm-style-iw-d {
            padding: 10px !important;
        }

        #MapCover{
          background-color: #1f2937;
          border: 1px solid #4b5563;
          width: 100%;
          height: calc(var(--vh, 1vh) * 65);
          border-radius: 12px;
          margin-bottom: 2em;
          padding: 8px;
        }

        .container {
            height: calc(var(--vh, 1vh) * 100);
            position: relative;
            max-width: 448px;
            margin: 0 auto;
            padding: 16px;
            min-height: calc(var(--vh, 1vh) * 100);
        }

        #info {
            padding-top: 10px;
            margin-bottom: 16px;
            text-align: center;
        }
        
        @import url("https://fonts.googleapis.com/css2?family=Edu+AU+VIC+WA+NT+Hand:wght@400..700&display=swap");

        @font-face {
            font-family: "Pretendard-Regular";
            src: url("https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff")
                format("woff");
            font-weight: 400;
            font-style: normal;
        }

        @font-face {
            font-family: "HSSanTokki20-Regular";
            src: url("https://fastly.jsdelivr.net/gh/projectnoonnu/2405@1.0/HSSanTokki20-Regular.woff2")
                format("woff2");
            font-weight: normal;
            font-style: normal;
        }


        .font-Pretendard-Regular {
            font-family: "Pretendard-Regular";
        }

        li {
            list-style-type: none;
        }

        .listyle {
            list-style-position: inside;
            text-indent: -10px;
        }

    .custom-marker {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 3px solid #f2d235;
      overflow: hidden;
      box-sizing: border-box;
      transition: transform 0.3s ease;
    }

    .custom-marker img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .custom-marker.enlarged {
      transform: scale(2);
      z-index: 1000;
    }

    .photozone-modal {
      padding: 8px;
      width: 100%;
      background-color: #374151;
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    /* 모달 박스 */
    .modal-box {
      width: 100%;
      background-color: white;
      border-radius: 12px;
      padding: 10px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    /* 제목 */
    .modal-title {
      color: #1f2937;
      font-size: 1.5em;
      font-weight: bold;
      text-align: center;
      margin-bottom: 5px;
    }

    .modal-sub-title {
      color: #1f2937;
      font-size: 1.2em;
      text-align: center;
      margin-bottom: 5px;
    }

    .modal-sub-contens {
      color: #1f2937;
      font-size: 1em;
      text-align: center;
      margin-bottom: 5px;       
    }
    /* 이미지 그리드 */
    .circle-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 10px;
      justify-items: center;
      align-items: center;
    }

    .circle-button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid #ccc;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .circle-button:hover {
      transform: scale(1.05);
    }

    .circle-button img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }  

    /* 오버레이로 사용할 이미지의 스타일 */
    .overlay-image {
        position: absolute; /* 지도 위에 떠 있도록 설정 */
        opacity: 0.8; /* 이미지 투명도 (선택 사항) */
        pointer-events: none; /* 오버레이 아래의 지도를 클릭할 수 있도록 설정 */
    }
    </style>
</head>
<body>
    <div class="container">
    <div id="info">
      <h1 style="color:#ffffff; margin-bottom: 8px; font-size: 1.7em;">🥽 AR 행성 체험 </h1>
      <!--span style="color: #e5e7eb; font-size: 18px;">증강현실로 행성을 만나보세요</span-->
    </div>
    
    <div id="MapCover">
        <div id="map"></div>
    </div>

    <div class="modal-buttons">
        <button class="btn-stamp" onclick="window.location.href = './scanner.html'";>🚀 QR코드 찍기</button>
    </div>
 
    
    <div id="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom: 16px; "></h2>
            <span style="color: #fef3c7; font-weight: bold; font-size: 1.2em">행성에 도착했습니다!</span>
            <div class="modal-buttons">
                <ul style="color: #fef3c7; font-size: 16px; ">
                  <li><button id="modal-stamp-btn" class="btn-stamp">행성 스탬프 수집</button></li>
                  <li><button id="modal-photo-btn" class="btn-photo">AR 포토존  가기</button></li>
                </ul>
            </div>
        </div>
    </div>

    <div id="status-modal">
        <div class="modal-content">
            <h2 id="status-modal-title" style="margin-bottom: 16px; "></h2>
            <span id="status-modal-text"></span>
              <div class="modal-buttons"><button id="status-modal-btn" class="btn-stamp" style="margin-bottom: 5px;"></button></div>
              <div class="modal-buttons"><button id="status-modal-close-btn" class="btn-photo" style="margin-bottom: 10px;">닫기</button></div>
        </div>
    </div>

    <div class="photozone-modal">
        <div class="modal-box">
          <div class="modal-sub-title">📷 AR 포토존 체험하기</div>
          <div class="modal-sub-contens">행성 버튼을 눌러 포토존을 체험하세요.</div>
          <div class="circle-grid">
            <a href="./photozone.html?planet=earth" class="circle-button"><img src="./images/earth.png" alt="지구 이미지"></a>
            <a href="./photozone.html?planet=mars" class="circle-button"><img src="./images/mars.png" alt="화성 이미지"></a>
            <a href="./photozone.html?planet=jupiter" class="circle-button"><img src="./images/jupiter.png" alt="목성 이미지"></a>
            <a href="./photozone.html?planet=saturn" class="circle-button"><img src="./images/saturn.png" alt="토성 이미지"></a>
            <a href="./photozone.html?planet=uranus" class="circle-button"><img src="./images/uranus.png" alt="천왕성 이미지"></a>
            <a href="./photozone.html?planet=neptune" class="circle-button"><img src="./images/neptune.png" alt="해왕성 이미지"></a>
          </div>
        </div> 
    </div>
    <div style="background-color: #854d0e; border-color: #ca8a04; padding: 16px; margin-bottom: 24px; border: 1px solid #4b5563; border-radius: 12px; backdrop-filter: blur(8px);">
        <h3 style="color: #ffffff; margin-bottom: 8px; font-size: 18px; align-items: center; display: flex;">
            <span style="color: #ffffff; font-size: 18px;">💡</span>
            <span>Tip</span>
        </h3>
        <ul style="color: #fef3c7; font-size: 1em; ">
            <li class="listyle">• 미션 시작 시 GPS와 카메라 권한을 허용해주세요</li>
            <li class="listyle">• 배터리를 충분히 충전하고 시작하세요</li>
            <li class="listyle">• 사람이 많은 곳에서 뛰거나 부딪히지 않도록 주의하세요</li>
        </ul>
    </div>
    </div>


    <script>
        let map; // 전역 변수로 map 객체 선언
        let userMarker = null;
        let activeModalId = null;
        let proximityCheckInterval = null;
        let hasShownOutOfBoundsAlert = false;

        const mapElement = document.getElementById('map');
        const eventCenterPoint1 = new naver.maps.LatLng(37.489122, 126.956116); // 이벤트 중심 좌표
        const eventCenterPoint = new naver.maps.LatLng(37.249746, 127.165157); // 이벤트 중심 좌표
        const eventRadius = 500; // 이벤트 참여 가능 반경 (500미터)

            const stampLocations = [
                { title: '🌍 지구', lat: 37.249180, lng: 127.165636, id: 'earth', marker: './images/earth.png' },
                { title: '🔴 화성', lat: 37.249109, lng: 127.164899, id: 'mars', marker: './images/mars.png' }, 
                { title: '🪐 목성', lat: 37.249725, lng: 127.165706, id: 'jupiter', marker: './images/jupiter.png' }, 
                { title: '💫 토성', lat: 37.250205, lng: 127.165469, id: 'saturn', marker: './images/saturn.png' },
                { title: '💎 천왕성', lat: 37.250205, lng: 127.164944, id: 'uranus', marker: './images/uranus.png' },
                { title: '🌊 해왕성', lat: 37.250235, lng: 127.164643, id: 'neptune', marker: './images/neptune.png' }, 
            ];

            const stampLocations1 = [
                { title: '🌍 지구', lat: 37.489121, lng: 126.955418, id: 'earth', marker: './images/earth.png' },
                { title: '🔴 화성', lat: 37.4895,   lng: 126.9556, id: 'mars', marker: './images/mars.png' },
                { title: '🪐 목성', lat: 37.4893,   lng: 126.9561, id: 'jupiter', marker: './images/jupiter.png' },
                { title: '💫 토성', lat: 37.488928, lng: 126.956250, id: 'saturn', marker: './images/saturn.png' },
                { title: '💎 천왕성', lat: 37.4891, lng: 126.9569, id: 'uranus', marker: './images/uranus.png' },
                { title: '🌊 해왕성', lat: 37.489086, lng: 126.956518, id: 'neptune', marker: './images/neptune.png' }, 
            ];

        const TOTAL_STAMPS = stampLocations.length;

        const statusModal = document.getElementById('status-modal');
        const statusModalText = document.getElementById('status-modal-text');
        const statusModalBtn = document.getElementById('status-modal-btn');
        const statusModalCloseBtn = document.getElementById('status-modal-close-btn');

        // 2. Google Maps API가 로드된 후 'initMap' 함수가 자동으로 호출됩니다.
        function initMap() {
                // ✨ 사용자 ID 확인 및 생성 로직 (가장 먼저 실행)
            let userId = localStorage.getItem('userId');
            if (!userId) {
               // crypto.randomUUID()는 매우 안전하고 고유한 ID를 생성하는 최신 표준 방식입니다.
                userId = crypto.randomUUID();
                localStorage.setItem('userId', userId);
                console.log(`새로운 사용자 ID가 생성되었습니다: ${userId}`);

                 // ✨ 새로 생성한 ID를 즉시 서버 DB에 등록
                fetch('/api/register-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userId })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        console.log("서버에 사용자가 성공적으로 등록되었습니다.");
                    }
                });
            } else {
                console.log(`기존 사용자 ID를 사용합니다: ${userId}`);
            }

            map = new naver.maps.Map(mapElement, {
                center: eventCenterPoint,
                zoom: 18,
            });

            // 사용자의 최종 상태를 먼저 확인
            checkUserStatusOnLoad();

            
//9월 19일 추가

// 1. 오버레이를 표시할 지리적 영역(bounds)을 정의합니다.
//    (예: 서울역과 남산타워를 잇는 사각형 영역)
const overlayBounds = new naver.maps.LatLngBounds(
    new naver.maps.LatLng(37.248601, 127.163775), // 남서쪽(South-West) 좌표
    new naver.maps.LatLng(37.250843, 127.166517)  // 북동쪽(North-East) 좌표
);

// 2. CustomOverlay를 상속받아 우리만의 오버레이 클래스를 만듭니다.
function ImageOverlay(bounds, imageUrl, map) {
    this._bounds = bounds;
    this._imageUrl = imageUrl;
    this._element = document.createElement('img');
    this._element.src = this._imageUrl;
    this._element.className = 'overlay-image';
    
    this.setMap(map);
}
// CustomOverlay의 프로토타입을 상속합니다.
ImageOverlay.prototype = new naver.maps.OverlayView();
ImageOverlay.prototype.constructor = ImageOverlay;

// 오버레이가 지도에 추가될 때 호출될 함수
ImageOverlay.prototype.onAdd = function() {
    const overlayLayer = this.getPanes().overlayImage;
    overlayLayer.appendChild(this._element);
};

// 오버레이를 그릴 때 호출될 함수 (지도 이동/줌 시 계속 호출됨)
ImageOverlay.prototype.draw = function() {
    const projection = this.getProjection();
    const sw = projection.fromCoordToOffset(this._bounds.getSW()); // 영역의 남서쪽 화면 좌표
    const ne = projection.fromCoordToOffset(this._bounds.getNE()); // 영역의 북동쪽 화면 좌표

    const width = ne.x - sw.x;
    const height = sw.y - ne.y;

    this._element.style.left = sw.x + 'px';
    this._element.style.top = ne.y + 'px';
    this._element.style.width = width + 'px';
    this._element.style.height = height + 'px';
};

// 오버레이가 지도에서 제거될 때 호출될 함수
ImageOverlay.prototype.onRemove = function() {
    this._element.parentNode.removeChild(this._element);
};

// 3. 생성한 오버레이 클래스의 인스턴스를 만들고 지도에 추가합니다.
const imageUrl = './images/mir-layout.png'; // 오버레이로 사용할 이미지 경로
const overlay = new ImageOverlay(overlayBounds, imageUrl, map);



// 종료지점

// 스탬프 존 마커 표시
            displayStampMarkers();

        let isFirstLoad = true;
        naver.maps.Event.addListener(map, 'idle', () => {
          if (isFirstLoad) {
            console.log("지도 로딩 완료. 위치 스캔을 시작합니다.");
            updateUserLocation();
            setInterval(updateUserLocation, 5000);
        
            isFirstLoad = false; // 플래그를 변경하여 다시는 실행되지 않도록 함
          }
        });   
    }

       function checkUserStatusOnLoad() {
            const userId = localStorage.getItem('userId');
            if (!userId) return; // 사용자 ID가 없으면 확인하지 않음

            const collectedStamps = JSON.parse(localStorage.getItem('stamps')) || {};

            const validStamps = Object.keys(collectedStamps).filter(key => 
                stampLocations.some(loc => loc.id === key)
            );
            const totalStamps = validStamps.length;

            // 스탬프를 모두 모았을 경우에만 서버에 확인
            if (totalStamps >= TOTAL_STAMPS) {
                fetch(`/api/check-eligibility/${userId}`)
                    .then(res => res.json())
                    .then(status => {
                        if (status.reason === '이미 경품을 수령했습니다.') {
                            // 경품까지 모두 수령한 경우
                            showStatusModal(
                                "참여 완료",
                                "이벤트에 참여해주셔서 감사합니다!" + '<br>' + "경품을 이미 수령하셨습니다.",
                                "확인"
                            );
                        } else if (status.eligible) {
                            // 스탬프는 다 모았지만 아직 경품을 받지 않은 경우
                            showStatusModal(
                                "스탬프 완성!",
                                "모든 스탬프를 모았습니다." + '<br>' + "경품을 받으러 가시겠습니까?",
                                "🎁 QR코드 찍기",
                                () => { window.location.href = 'scanner.html'; }
                            );
                        }
                    });
            }
        }

        // ✨ 3. 마커를 생성하는 로직을 별도 함수로 분리
        function displayStampMarkers() {
            const markerElements = []; // 모든 마커 DOM 요소 저장
            const collectedStamps = JSON.parse(localStorage.getItem('stamps')) || {};

            stampLocations.forEach(loc => {
                const markerEl = document.createElement('div');
                markerEl.className = 'custom-marker';
                markerEl.innerHTML = `<img src="${loc.marker}" alt="마커 이미지">`;

                markerEl.addEventListener('click', () => {
                    markerElements.forEach(el => el.classList.remove('enlarged'));
                    markerEl.classList.add('enlarged');
                });

                naver.maps.Event.addListener(map, 'click', () => {
                   markerElements.forEach(el => el.classList.remove('enlarged'));
                });
                 
                if (collectedStamps[loc.id]) {
                    markerEl.style.borderColor = "red"
                    markerEl.style.filter = "brightness(50%)";
                }
                markerElements.push(markerEl);

                const position = new naver.maps.LatLng(loc.lat, loc.lng);
                const marker = new naver.maps.Marker({
                    position, 
                    map: map,
                    title: loc.title,
                    icon: {
//                       url: markerIconUrl, //50, 68 크기의 원본 이미지  -> 50, 50 으로 변경
                       content: markerEl,
                       size: new naver.maps.Size(50, 50),
                       scaledSize: new naver.maps.Size(25, 25),
                       origin: new naver.maps.Point(0, 0),
                       anchor: new naver.maps.Point(25, 25)
                    }
                });

                const infoWindow = new naver.maps.InfoWindow({ 
                    content: `<div style="padding:5px;font-size:12px;text-align:center; color: black;">${loc.title}</div>`
                });
              
                naver.maps.Event.addListener(marker, 'mouseover', () => infoWindow.open(map, marker));
                naver.maps.Event.addListener(marker, 'mouseout', () => infoWindow.close());
                naver.maps.Event.addListener(marker, 'click', () => infoWindow.open(map, marker));             
            });

//9월 19일 상품수령처 마커 추가
    const infoMarkerLocation = {
        title: 'ℹ️ 경품 수령처',
        lat: 37.249329,  
        lng: 127.165839,
    };
    const infoMarkerPosition = new naver.maps.LatLng(infoMarkerLocation.lat, infoMarkerLocation.lng);

    // 안내 마커를 생성합니다.
    const infoMarker = new naver.maps.Marker({
        position: infoMarkerPosition,
        map: map,
        title: infoMarkerLocation.title,
        icon: { // 다른 마커와 구분되도록 아이콘을 다르게 설정
            url: './images/prize50.png', // 예시 아이콘 경로
            size: new naver.maps.Size(50, 50),
            anchor: new naver.maps.Point(25, 50)
        }
    });

    // 안내 마커에 대한 정보창을 생성합니다.
    const infoWindow = new naver.maps.InfoWindow({
        content: `<div style="padding:5px;font-size:12px;text-align:center; color: black">${infoMarkerLocation.title}</div>`
    });

    // 마우스를 올리면 정보창이 나타나도록 이벤트를 추가합니다.
    naver.maps.Event.addListener(infoMarker, 'mouseover', () => {
        infoWindow.open(map, infoMarker);
    });
    naver.maps.Event.addListener(infoMarker, 'mouseout', () => {
        infoWindow.close();
    });

    // ✨ 1. 마커의 확대 상태를 기억할 변수를 선언합니다.
    let isMarkerEnlarged = false;

    // ✨ 2. 마커를 클릭했을 때의 동작을 아래 로직으로 교체합니다.
    naver.maps.Event.addListener(infoMarker, 'click', () => {
        if (isMarkerEnlarged) {
            // 현재 확대된 상태이면, 원래 크기로 되돌립니다.
            infoMarker.setIcon({
                url: './images/prize50.png',
                size: new naver.maps.Size(50, 50),
                anchor: new naver.maps.Point(25, 50)
            });
            isMarkerEnlarged = false;
        } else {
            // 현재 원래 크기이면, 더 큰 사이즈로 변경합니다.
            infoMarker.setIcon({
                url: './images/prize50.png',
                size: new naver.maps.Size(100, 100), // 예: 1.5배 큰 사이즈
                anchor: new naver.maps.Point(25, 50) // 고정점도 그에 맞게 변경
            });
            isMarkerEnlarged = true;
        }
    });

//추가 끝

        }

        function getDistanceInMeters(lat1, lng1, lat2, lng2) {
            function toRad(value) { return value * Math.PI / 180; }
            const R = 6371e3; // 지구 반지름 (미터)
            const dLat = toRad(lat2 - lat1);
            const dLng = toRad(lng2 - lng1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // ✨ 3. 상태 팝업창을 보여주는 함수
        function showStatusModal(title, text, buttonText, buttonAction = null) {
            document.getElementById('status-modal-title').textContent = title;
            statusModalText.innerHTML = text;
            statusModalBtn.textContent = buttonText;
            
            if (buttonAction) {
                statusModalBtn.style.display = 'inline-block';
                statusModalBtn.onclick = buttonAction;
            } else {
                statusModalBtn.style.display = 'none'; // 버튼이 필요 없는 경우 숨김
            }
        
            statusModal.style.display = 'flex';
            statusModal.style.zindex = '99999';
        }

        statusModalCloseBtn.onclick = () => {
            statusModal.style.display = 'none';
        };

        let lastKnownPosition = null;

        function updateUserLocation() {
            const proximityModal = document.getElementById('modal');

            if (proximityModal.style.display === 'flex' && activeModalId) {
                const loc = stampLocations.find(l => l.id === activeModalId);
                if (loc) {
                    const distance = getDistanceInMeters(lastKnownPosition.lat(), lastKnownPosition.lng(), loc.lat, loc.lng);
            
            // 사용자가 해당 스탬프 존에서 25미터 이상 벗어나면 팝업을 닫습니다.
                    if (distance > 25) {
                        console.log("사용자가 팝업 존을 벗어나서, 팝업을 자동으로 닫습니다.");
                        closeModal(); // 팝업을 닫는 함수 호출
                    }
                }
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const userPosition = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude);

                    if (!map) return; // map이 아직 준비되지 않았으면 실행하지 않음
                
                    lastKnownPosition = userPosition;

                    const distance = getDistanceInMeters(userPosition.lat(), userPosition.lng(), eventCenterPoint.lat(), eventCenterPoint.lng());

                    if (distance > eventRadius) {

                        if (!hasShownOutOfBoundsAlert) {
                            alert("이벤트 장소에서 벗어났습니다. 행사장으로 이동하여 다시 시도해주세요.");
                        // ✨ 2. 알림을 한번 보여줬다고 상태를 기록합니다.
                            hasShownOutOfBoundsAlert = true;
                        }
                        // 내 위치 마커가 있다면 숨깁니다.
                        if (userMarker) {
                            userMarker.setMap(null); 
                        }
                        return; // 스탬프 근접 확인 로직을 실행하지 않음
                    }

                    hasShownOutOfBoundsAlert = false;

                    if (userMarker) {
                        userMarker.setPosition(userPosition);
                        if (userMarker.getMap() === null) {
                            userMarker.setMap(map); // 숨겨져 있었다면 다시 표시
                        }
                    } else {
                        userMarker = new naver.maps.Marker({
                            position: userPosition,
                            map: map,
                            title: "내 위치",
                            icon: {
                                content: [
                                '<div style="text-align: center;">',
                                '    <img src="./images/my_loc_icon.png" alt="내 위치" ',
                                '         style="width: 40px; height: 40px;">', // 이미지 크기
                                '</div>'
                                ].join(''),
                                anchor: new naver.maps.Point(20, 20) // 이미지 크기의 절반
                            }
                        });
                    }    
                    checkProximity(userPosition);
                }, () => { alert("위치 정보를 가져오는 데 실패했습니다."); });
            }
        }

        function checkProximity(userPosition) {

            if(activeModalId) return; // 모달이 이미 떠있으면 추가 확인 안함

            const proximityLimit = 30; // 20미터에서 30m로 변경
            
            for (const loc of stampLocations) {
                const distance = getDistanceInMeters(userPosition.lat(), userPosition.lng(), loc.lat, loc.lng);
                if (distance <= proximityLimit) {
                    const collectedStamps = JSON.parse(localStorage.getItem('stamps')) || {};

                    const hasStamp = collectedStamps[loc.id];    //9.12 수정

 //                   showProximityModal(loc.title, loc.id, hasStamp); //9.12 수정
 //                   break;   //9.12 수정

                    if (!collectedStamps[loc.id]) {
                        showProximityModal(loc.title, loc.id, hasStamp);
                        break;
                    }
                } 
            }
        }

    //    let activeModalId = null;

        function showProximityModal(title, id, hasStamp) {
            if(activeModalId === id) return;
            activeModalId = id;

            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            
            const modalText = modal.querySelector('span'); // 팝업창의 p 태그를 선택
            const modalStampBtn = document.getElementById('modal-stamp-btn');
            const modalPhotoBtn = document.getElementById('modal-photo-btn');

            modalTitle.textContent = title;
            modal.style.display = 'flex';

            if (hasStamp) {
        // 이미 스탬프를 획득한 경우
//                modalText.innerHTML = "이미 스탬프를 획득했습니다." + '<br>' + "포토존을 이용하시겠습니까?";
//                modalStampBtn.style.display = 'none'; // '스탬프 투어 참여' 버튼 숨기기
//                modalPhotoBtn.style.display = 'inline-block'; // 'AR 포토존 가기' 버튼은 보이게
            } else {
        // 아직 스탬프를 획득하지 않은 경우
                modalText.textContent = "행성에 도착했습니다.";
                modalStampBtn.style.display = 'inline-block'; // '스탬프 투어 참여' 버튼 보이기
                modalPhotoBtn.style.display = 'inline-block'; // 'AR 포토존 가기' 버튼도 보이기
                modalStampBtn.onclick = () => { window.location.href = `stamptour.html?planet=${id}`; };
                modalPhotoBtn.onclick = () => { window.location.href = `photozone.html?planet=${id}`; };
            }        
        }

        window.onclick = (event) => {
            const modal = document.getElementById('modal');
            if (event.target == modal) {
                modal.style.display = "none";
                activeModalId = null;
            }
        }

    function closeModal() {
        const proximityModal = document.getElementById('modal');
        proximityModal.style.display = 'none';
        activeModalId = null;
    }   

        // 페이지 로드 후 1초 뒤부터 위치 확인 시작 (지도 로딩 시간 확보)
    setTimeout(() => {
        updateUserLocation();
        setInterval(updateUserLocation, 5000);
    }, 1000);

</script>

</body>
</html>