<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤íƒ¬í”„ íˆ¬ì–´ - í–‰ì„± ì—¬í–‰</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=eb9mai2ikc&callback=initMap"></script>

    <script>
        function setScreenHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        window.addEventListener('resize', setScreenHeight);
        setScreenHeight(); // ìµœì´ˆ ì‹¤í–‰
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body { 
            height: calc(var(--vh, 1vh) * 100); 
            margin: 0; 
            padding: 0; 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            background-color: #111827;
            color: #ffffff;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: hidden;

        }
        #map { 
            height: calc(var(--vh, 1vh) * 65); 
            margin: 0; 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            background-color: #111827;
            color: #ffffff;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: hidden;
            border: 1px solid #4b5563;
            overflow: hidden;
            padding: 16px; 
            border-radius: 12px;
        }
        #modal, #status-modal { display: none; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 9999; width: 80vw; height: calc(var(--vh, 1vh) * 40);; max-width: 220px;}
        .modal-content { width: 100%; position: absolute; background-color: #1f2937; margin: auto; padding: 15px; border-radius: 10px; text-align: center; grid-template-columns: 1fr; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 15px; width: 100%; }
        .modal-buttons button { height: 4em; padding: 10px 20px; font-size: 1em; cursor: pointer; border-radius: 5px; border: none; color: white; margin-bottom: 15px; }
        .btn-stamp { background-color: #007bff; width: 100%;}
        .btn-photo { background-color: #28a745; width: 100%;}

        .gm-style-iw-c button {
            display: none !important;
        }
        .gm-style-iw-d {
            padding: 10px !important;
        }

        #MapCover{
          background-color: #1f2937;
          border: 1px solid #4b5563;
          width: 100%;
          height: calc(var(--vh, 1vh) * 65);
          border-radius: 12px;
          margin-bottom: 2em;
          padding: 8px;
        }

        .container {
            height: calc(var(--vh, 1vh) * 100);
            position: relative;
            max-width: 448px;
            margin: 0 auto;
            padding: 16px;
            min-height: calc(var(--vh, 1vh) * 100);
        }

        #info {
            padding-top: 10px;
            margin-bottom: 16px;
            text-align: center;
        }
        
        @import url("https://fonts.googleapis.com/css2?family=Edu+AU+VIC+WA+NT+Hand:wght@400..700&display=swap");

        @font-face {
            font-family: "Pretendard-Regular";
            src: url("https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff")
                format("woff");
            font-weight: 400;
            font-style: normal;
        }

        @font-face {
            font-family: "HSSanTokki20-Regular";
            src: url("https://fastly.jsdelivr.net/gh/projectnoonnu/2405@1.0/HSSanTokki20-Regular.woff2")
                format("woff2");
            font-weight: normal;
            font-style: normal;
        }


        .font-Pretendard-Regular {
            font-family: "Pretendard-Regular";
        }

        li {
            list-style-type: none;
        }

        .listyle {
            list-style-position: inside;
            text-indent: -10px;
        }

    .custom-marker {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 3px solid #f2d235;
      overflow: hidden;
      box-sizing: border-box;
      transition: transform 0.3s ease;
    }

    .custom-marker img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .custom-marker.enlarged {
      transform: scale(2);
      z-index: 1000;
    }

    .photozone-modal {
      padding: 8px;
      width: 100%;
      background-color: #374151;
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    /* ëª¨ë‹¬ ë°•ìŠ¤ */
    .modal-box {
      width: 100%;
      background-color: white;
      border-radius: 12px;
      padding: 10px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    /* ì œëª© */
    .modal-title {
      color: #1f2937;
      font-size: 1.5em;
      font-weight: bold;
      text-align: center;
      margin-bottom: 5px;
    }

    .modal-sub-title {
      color: #1f2937;
      font-size: 1.2em;
      text-align: center;
      margin-bottom: 5px;
    }

    .modal-sub-contens {
      color: #1f2937;
      font-size: 1em;
      text-align: center;
      margin-bottom: 5px;       
    }
    /* ì´ë¯¸ì§€ ê·¸ë¦¬ë“œ */
    .circle-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 10px;
      justify-items: center;
      align-items: center;
    }

    .circle-button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid #ccc;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .circle-button:hover {
      transform: scale(1.05);
    }

    .circle-button img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }  

    /* ì˜¤ë²„ë ˆì´ë¡œ ì‚¬ìš©í•  ì´ë¯¸ì§€ì˜ ìŠ¤íƒ€ì¼ */
    .overlay-image {
        position: absolute; /* ì§€ë„ ìœ„ì— ë–  ìˆë„ë¡ ì„¤ì • */
        opacity: 0.8; /* ì´ë¯¸ì§€ íˆ¬ëª…ë„ (ì„ íƒ ì‚¬í•­) */
        pointer-events: none; /* ì˜¤ë²„ë ˆì´ ì•„ë˜ì˜ ì§€ë„ë¥¼ í´ë¦­í•  ìˆ˜ ìˆë„ë¡ ì„¤ì • */
    }
    </style>
</head>
<body>
    <div class="container">
    <div id="info">
      <h1 style="color:#ffffff; margin-bottom: 8px; font-size: 1.7em;">ğŸ¥½ AR í–‰ì„± ì²´í—˜ </h1>
      <!--span style="color: #e5e7eb; font-size: 18px;">ì¦ê°•í˜„ì‹¤ë¡œ í–‰ì„±ì„ ë§Œë‚˜ë³´ì„¸ìš”</span-->
    </div>
    
    <div id="MapCover">
        <div id="map"></div>
    </div>

    <div class="modal-buttons">
        <button class="btn-stamp" onclick="window.location.href = './scanner.html'";>ğŸš€ QRì½”ë“œ ì°ê¸°</button>
    </div>
 
    
    <div id="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom: 16px; "></h2>
            <span style="color: #fef3c7; font-weight: bold; font-size: 1.2em">í–‰ì„±ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤!</span>
            <div class="modal-buttons">
                <ul style="color: #fef3c7; font-size: 16px; ">
                  <li><button id="modal-stamp-btn" class="btn-stamp">í–‰ì„± ìŠ¤íƒ¬í”„ ìˆ˜ì§‘</button></li>
                  <li><button id="modal-photo-btn" class="btn-photo">AR í¬í† ì¡´  ê°€ê¸°</button></li>
                </ul>
            </div>
        </div>
    </div>

    <div id="status-modal">
        <div class="modal-content">
            <h2 id="status-modal-title" style="margin-bottom: 16px; "></h2>
            <span id="status-modal-text"></span>
              <div class="modal-buttons"><button id="status-modal-btn" class="btn-stamp" style="margin-bottom: 5px;"></button></div>
              <div class="modal-buttons"><button id="status-modal-close-btn" class="btn-photo" style="margin-bottom: 10px;">ë‹«ê¸°</button></div>
        </div>
    </div>

    <div class="photozone-modal">
        <div class="modal-box">
          <div class="modal-sub-title">ğŸ“· AR í¬í† ì¡´ ì²´í—˜í•˜ê¸°</div>
          <div class="modal-sub-contens">í–‰ì„± ë²„íŠ¼ì„ ëˆŒëŸ¬ í¬í† ì¡´ì„ ì²´í—˜í•˜ì„¸ìš”.</div>
          <div class="circle-grid">
            <a href="./photozone.html?planet=earth" class="circle-button"><img src="./images/earth.png" alt="ì§€êµ¬ ì´ë¯¸ì§€"></a>
            <a href="./photozone.html?planet=mars" class="circle-button"><img src="./images/mars.png" alt="í™”ì„± ì´ë¯¸ì§€"></a>
            <a href="./photozone.html?planet=jupiter" class="circle-button"><img src="./images/jupiter.png" alt="ëª©ì„± ì´ë¯¸ì§€"></a>
            <a href="./photozone.html?planet=saturn" class="circle-button"><img src="./images/saturn.png" alt="í† ì„± ì´ë¯¸ì§€"></a>
            <a href="./photozone.html?planet=uranus" class="circle-button"><img src="./images/uranus.png" alt="ì²œì™•ì„± ì´ë¯¸ì§€"></a>
            <a href="./photozone.html?planet=neptune" class="circle-button"><img src="./images/neptune.png" alt="í•´ì™•ì„± ì´ë¯¸ì§€"></a>
          </div>
        </div> 
    </div>
    <div style="background-color: #854d0e; border-color: #ca8a04; padding: 16px; margin-bottom: 24px; border: 1px solid #4b5563; border-radius: 12px; backdrop-filter: blur(8px);">
        <h3 style="color: #ffffff; margin-bottom: 8px; font-size: 18px; align-items: center; display: flex;">
            <span style="color: #ffffff; font-size: 18px;">ğŸ’¡</span>
            <span>Tip</span>
        </h3>
        <ul style="color: #fef3c7; font-size: 1em; ">
            <li class="listyle">â€¢ ë¯¸ì…˜ ì‹œì‘ ì‹œ GPSì™€ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”</li>
            <li class="listyle">â€¢ ë°°í„°ë¦¬ë¥¼ ì¶©ë¶„íˆ ì¶©ì „í•˜ê³  ì‹œì‘í•˜ì„¸ìš”</li>
            <li class="listyle">â€¢ ì‚¬ëŒì´ ë§ì€ ê³³ì—ì„œ ë›°ê±°ë‚˜ ë¶€ë”ªíˆì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ì„¸ìš”</li>
        </ul>
    </div>
    </div>


    <script>
        let map; // ì „ì—­ ë³€ìˆ˜ë¡œ map ê°ì²´ ì„ ì–¸
        let userMarker = null;
        let activeModalId = null;
        let proximityCheckInterval = null;
        let hasShownOutOfBoundsAlert = false;

        const mapElement = document.getElementById('map');
        const eventCenterPoint1 = new naver.maps.LatLng(37.489122, 126.956116); // ì´ë²¤íŠ¸ ì¤‘ì‹¬ ì¢Œí‘œ
        const eventCenterPoint = new naver.maps.LatLng(37.249746, 127.165157); // ì´ë²¤íŠ¸ ì¤‘ì‹¬ ì¢Œí‘œ
        const eventRadius = 500; // ì´ë²¤íŠ¸ ì°¸ì—¬ ê°€ëŠ¥ ë°˜ê²½ (500ë¯¸í„°)

            const stampLocations = [
                { title: 'ğŸŒ ì§€êµ¬', lat: 37.249180, lng: 127.165636, id: 'earth', marker: './images/earth.png' },
                { title: 'ğŸ”´ í™”ì„±', lat: 37.249109, lng: 127.164899, id: 'mars', marker: './images/mars.png' }, 
                { title: 'ğŸª ëª©ì„±', lat: 37.249725, lng: 127.165706, id: 'jupiter', marker: './images/jupiter.png' }, 
                { title: 'ğŸ’« í† ì„±', lat: 37.250205, lng: 127.165469, id: 'saturn', marker: './images/saturn.png' },
                { title: 'ğŸ’ ì²œì™•ì„±', lat: 37.250205, lng: 127.164944, id: 'uranus', marker: './images/uranus.png' },
                { title: 'ğŸŒŠ í•´ì™•ì„±', lat: 37.250235, lng: 127.164643, id: 'neptune', marker: './images/neptune.png' }, 
            ];

            const stampLocations1 = [
                { title: 'ğŸŒ ì§€êµ¬', lat: 37.489121, lng: 126.955418, id: 'earth', marker: './images/earth.png' },
                { title: 'ğŸ”´ í™”ì„±', lat: 37.4895,   lng: 126.9556, id: 'mars', marker: './images/mars.png' },
                { title: 'ğŸª ëª©ì„±', lat: 37.4893,   lng: 126.9561, id: 'jupiter', marker: './images/jupiter.png' },
                { title: 'ğŸ’« í† ì„±', lat: 37.488928, lng: 126.956250, id: 'saturn', marker: './images/saturn.png' },
                { title: 'ğŸ’ ì²œì™•ì„±', lat: 37.4891, lng: 126.9569, id: 'uranus', marker: './images/uranus.png' },
                { title: 'ğŸŒŠ í•´ì™•ì„±', lat: 37.489086, lng: 126.956518, id: 'neptune', marker: './images/neptune.png' }, 
            ];

        const TOTAL_STAMPS = stampLocations.length;

        const statusModal = document.getElementById('status-modal');
        const statusModalText = document.getElementById('status-modal-text');
        const statusModalBtn = document.getElementById('status-modal-btn');
        const statusModalCloseBtn = document.getElementById('status-modal-close-btn');

        // 2. Google Maps APIê°€ ë¡œë“œëœ í›„ 'initMap' í•¨ìˆ˜ê°€ ìë™ìœ¼ë¡œ í˜¸ì¶œë©ë‹ˆë‹¤.
        function initMap() {
                // âœ¨ ì‚¬ìš©ì ID í™•ì¸ ë° ìƒì„± ë¡œì§ (ê°€ì¥ ë¨¼ì € ì‹¤í–‰)
            let userId = localStorage.getItem('userId');
            if (!userId) {
               // crypto.randomUUID()ëŠ” ë§¤ìš° ì•ˆì „í•˜ê³  ê³ ìœ í•œ IDë¥¼ ìƒì„±í•˜ëŠ” ìµœì‹  í‘œì¤€ ë°©ì‹ì…ë‹ˆë‹¤.
                userId = crypto.randomUUID();
                localStorage.setItem('userId', userId);
                console.log(`ìƒˆë¡œìš´ ì‚¬ìš©ì IDê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ${userId}`);

                 // âœ¨ ìƒˆë¡œ ìƒì„±í•œ IDë¥¼ ì¦‰ì‹œ ì„œë²„ DBì— ë“±ë¡
                fetch('/api/register-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userId })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        console.log("ì„œë²„ì— ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                });
            } else {
                console.log(`ê¸°ì¡´ ì‚¬ìš©ì IDë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤: ${userId}`);
            }

            map = new naver.maps.Map(mapElement, {
                center: eventCenterPoint,
                zoom: 18,
            });

            // ì‚¬ìš©ìì˜ ìµœì¢… ìƒíƒœë¥¼ ë¨¼ì € í™•ì¸
            checkUserStatusOnLoad();

            
//9ì›” 19ì¼ ì¶”ê°€

// 1. ì˜¤ë²„ë ˆì´ë¥¼ í‘œì‹œí•  ì§€ë¦¬ì  ì˜ì—­(bounds)ì„ ì •ì˜í•©ë‹ˆë‹¤.
//    (ì˜ˆ: ì„œìš¸ì—­ê³¼ ë‚¨ì‚°íƒ€ì›Œë¥¼ ì‡ëŠ” ì‚¬ê°í˜• ì˜ì—­)
const overlayBounds = new naver.maps.LatLngBounds(
    new naver.maps.LatLng(37.248601, 127.163775), // ë‚¨ì„œìª½(South-West) ì¢Œí‘œ
    new naver.maps.LatLng(37.250843, 127.166517)  // ë¶ë™ìª½(North-East) ì¢Œí‘œ
);

// 2. CustomOverlayë¥¼ ìƒì†ë°›ì•„ ìš°ë¦¬ë§Œì˜ ì˜¤ë²„ë ˆì´ í´ë˜ìŠ¤ë¥¼ ë§Œë“­ë‹ˆë‹¤.
function ImageOverlay(bounds, imageUrl, map) {
    this._bounds = bounds;
    this._imageUrl = imageUrl;
    this._element = document.createElement('img');
    this._element.src = this._imageUrl;
    this._element.className = 'overlay-image';
    
    this.setMap(map);
}
// CustomOverlayì˜ í”„ë¡œí† íƒ€ì…ì„ ìƒì†í•©ë‹ˆë‹¤.
ImageOverlay.prototype = new naver.maps.OverlayView();
ImageOverlay.prototype.constructor = ImageOverlay;

// ì˜¤ë²„ë ˆì´ê°€ ì§€ë„ì— ì¶”ê°€ë  ë•Œ í˜¸ì¶œë  í•¨ìˆ˜
ImageOverlay.prototype.onAdd = function() {
    const overlayLayer = this.getPanes().overlayImage;
    overlayLayer.appendChild(this._element);
};

// ì˜¤ë²„ë ˆì´ë¥¼ ê·¸ë¦´ ë•Œ í˜¸ì¶œë  í•¨ìˆ˜ (ì§€ë„ ì´ë™/ì¤Œ ì‹œ ê³„ì† í˜¸ì¶œë¨)
ImageOverlay.prototype.draw = function() {
    const projection = this.getProjection();
    const sw = projection.fromCoordToOffset(this._bounds.getSW()); // ì˜ì—­ì˜ ë‚¨ì„œìª½ í™”ë©´ ì¢Œí‘œ
    const ne = projection.fromCoordToOffset(this._bounds.getNE()); // ì˜ì—­ì˜ ë¶ë™ìª½ í™”ë©´ ì¢Œí‘œ

    const width = ne.x - sw.x;
    const height = sw.y - ne.y;

    this._element.style.left = sw.x + 'px';
    this._element.style.top = ne.y + 'px';
    this._element.style.width = width + 'px';
    this._element.style.height = height + 'px';
};

// ì˜¤ë²„ë ˆì´ê°€ ì§€ë„ì—ì„œ ì œê±°ë  ë•Œ í˜¸ì¶œë  í•¨ìˆ˜
ImageOverlay.prototype.onRemove = function() {
    this._element.parentNode.removeChild(this._element);
};

// 3. ìƒì„±í•œ ì˜¤ë²„ë ˆì´ í´ë˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“¤ê³  ì§€ë„ì— ì¶”ê°€í•©ë‹ˆë‹¤.
const imageUrl = './images/mir-layout.png'; // ì˜¤ë²„ë ˆì´ë¡œ ì‚¬ìš©í•  ì´ë¯¸ì§€ ê²½ë¡œ
const overlay = new ImageOverlay(overlayBounds, imageUrl, map);



// ì¢…ë£Œì§€ì 

// ìŠ¤íƒ¬í”„ ì¡´ ë§ˆì»¤ í‘œì‹œ
            displayStampMarkers();

        let isFirstLoad = true;
        naver.maps.Event.addListener(map, 'idle', () => {
          if (isFirstLoad) {
            console.log("ì§€ë„ ë¡œë”© ì™„ë£Œ. ìœ„ì¹˜ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤.");
            updateUserLocation();
            setInterval(updateUserLocation, 5000);
        
            isFirstLoad = false; // í”Œë˜ê·¸ë¥¼ ë³€ê²½í•˜ì—¬ ë‹¤ì‹œëŠ” ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ í•¨
          }
        });   
    }

       function checkUserStatusOnLoad() {
            const userId = localStorage.getItem('userId');
            if (!userId) return; // ì‚¬ìš©ì IDê°€ ì—†ìœ¼ë©´ í™•ì¸í•˜ì§€ ì•ŠìŒ

            const collectedStamps = JSON.parse(localStorage.getItem('stamps')) || {};

            const validStamps = Object.keys(collectedStamps).filter(key => 
                stampLocations.some(loc => loc.id === key)
            );
            const totalStamps = validStamps.length;

            // ìŠ¤íƒ¬í”„ë¥¼ ëª¨ë‘ ëª¨ì•˜ì„ ê²½ìš°ì—ë§Œ ì„œë²„ì— í™•ì¸
            if (totalStamps >= TOTAL_STAMPS) {
                fetch(`/api/check-eligibility/${userId}`)
                    .then(res => res.json())
                    .then(status => {
                        if (status.reason === 'ì´ë¯¸ ê²½í’ˆì„ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤.') {
                            // ê²½í’ˆê¹Œì§€ ëª¨ë‘ ìˆ˜ë ¹í•œ ê²½ìš°
                            showStatusModal(
                                "ì°¸ì—¬ ì™„ë£Œ",
                                "ì´ë²¤íŠ¸ì— ì°¸ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!" + '<br>' + "ê²½í’ˆì„ ì´ë¯¸ ìˆ˜ë ¹í•˜ì…¨ìŠµë‹ˆë‹¤.",
                                "í™•ì¸"
                            );
                        } else if (status.eligible) {
                            // ìŠ¤íƒ¬í”„ëŠ” ë‹¤ ëª¨ì•˜ì§€ë§Œ ì•„ì§ ê²½í’ˆì„ ë°›ì§€ ì•Šì€ ê²½ìš°
                            showStatusModal(
                                "ìŠ¤íƒ¬í”„ ì™„ì„±!",
                                "ëª¨ë“  ìŠ¤íƒ¬í”„ë¥¼ ëª¨ì•˜ìŠµë‹ˆë‹¤." + '<br>' + "ê²½í’ˆì„ ë°›ìœ¼ëŸ¬ ê°€ì‹œê² ìŠµë‹ˆê¹Œ?",
                                "ğŸ QRì½”ë“œ ì°ê¸°",
                                () => { window.location.href = 'scanner.html'; }
                            );
                        }
                    });
            }
        }

        // âœ¨ 3. ë§ˆì»¤ë¥¼ ìƒì„±í•˜ëŠ” ë¡œì§ì„ ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
        function displayStampMarkers() {
            const markerElements = []; // ëª¨ë“  ë§ˆì»¤ DOM ìš”ì†Œ ì €ì¥
            const collectedStamps = JSON.parse(localStorage.getItem('stamps')) || {};

            stampLocations.forEach(loc => {
                const markerEl = document.createElement('div');
                markerEl.className = 'custom-marker';
                markerEl.innerHTML = `<img src="${loc.marker}" alt="ë§ˆì»¤ ì´ë¯¸ì§€">`;

                markerEl.addEventListener('click', () => {
                    markerElements.forEach(el => el.classList.remove('enlarged'));
                    markerEl.classList.add('enlarged');
                });

                naver.maps.Event.addListener(map, 'click', () => {
                   markerElements.forEach(el => el.classList.remove('enlarged'));
                });
                 
                if (collectedStamps[loc.id]) {
                    markerEl.style.borderColor = "red"
                    markerEl.style.filter = "brightness(50%)";
                }
                markerElements.push(markerEl);

                const position = new naver.maps.LatLng(loc.lat, loc.lng);
                const marker = new naver.maps.Marker({
                    position, 
                    map: map,
                    title: loc.title,
                    icon: {
//                       url: markerIconUrl, //50, 68 í¬ê¸°ì˜ ì›ë³¸ ì´ë¯¸ì§€  -> 50, 50 ìœ¼ë¡œ ë³€ê²½
                       content: markerEl,
                       size: new naver.maps.Size(50, 50),
                       scaledSize: new naver.maps.Size(25, 25),
                       origin: new naver.maps.Point(0, 0),
                       anchor: new naver.maps.Point(25, 25)
                    }
                });

                const infoWindow = new naver.maps.InfoWindow({ 
                    content: `<div style="padding:5px;font-size:12px;text-align:center; color: black;">${loc.title}</div>`
                });
              
                naver.maps.Event.addListener(marker, 'mouseover', () => infoWindow.open(map, marker));
                naver.maps.Event.addListener(marker, 'mouseout', () => infoWindow.close());
                naver.maps.Event.addListener(marker, 'click', () => infoWindow.open(map, marker));             
            });

//9ì›” 19ì¼ ìƒí’ˆìˆ˜ë ¹ì²˜ ë§ˆì»¤ ì¶”ê°€
    const infoMarkerLocation = {
        title: 'â„¹ï¸ ê²½í’ˆ ìˆ˜ë ¹ì²˜',
        lat: 37.249329,  
        lng: 127.165839,
    };
    const infoMarkerPosition = new naver.maps.LatLng(infoMarkerLocation.lat, infoMarkerLocation.lng);

    // ì•ˆë‚´ ë§ˆì»¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    const infoMarker = new naver.maps.Marker({
        position: infoMarkerPosition,
        map: map,
        title: infoMarkerLocation.title,
        icon: { // ë‹¤ë¥¸ ë§ˆì»¤ì™€ êµ¬ë¶„ë˜ë„ë¡ ì•„ì´ì½˜ì„ ë‹¤ë¥´ê²Œ ì„¤ì •
            url: './images/prize50.png', // ì˜ˆì‹œ ì•„ì´ì½˜ ê²½ë¡œ
            size: new naver.maps.Size(50, 50),
            anchor: new naver.maps.Point(25, 50)
        }
    });

    // ì•ˆë‚´ ë§ˆì»¤ì— ëŒ€í•œ ì •ë³´ì°½ì„ ìƒì„±í•©ë‹ˆë‹¤.
    const infoWindow = new naver.maps.InfoWindow({
        content: `<div style="padding:5px;font-size:12px;text-align:center; color: black">${infoMarkerLocation.title}</div>`
    });

    // ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì •ë³´ì°½ì´ ë‚˜íƒ€ë‚˜ë„ë¡ ì´ë²¤íŠ¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    naver.maps.Event.addListener(infoMarker, 'mouseover', () => {
        infoWindow.open(map, infoMarker);
    });
    naver.maps.Event.addListener(infoMarker, 'mouseout', () => {
        infoWindow.close();
    });

    // âœ¨ 1. ë§ˆì»¤ì˜ í™•ëŒ€ ìƒíƒœë¥¼ ê¸°ì–µí•  ë³€ìˆ˜ë¥¼ ì„ ì–¸í•©ë‹ˆë‹¤.
    let isMarkerEnlarged = false;

    // âœ¨ 2. ë§ˆì»¤ë¥¼ í´ë¦­í–ˆì„ ë•Œì˜ ë™ì‘ì„ ì•„ë˜ ë¡œì§ìœ¼ë¡œ êµì²´í•©ë‹ˆë‹¤.
    naver.maps.Event.addListener(infoMarker, 'click', () => {
        if (isMarkerEnlarged) {
            // í˜„ì¬ í™•ëŒ€ëœ ìƒíƒœì´ë©´, ì›ë˜ í¬ê¸°ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
            infoMarker.setIcon({
                url: './images/prize50.png',
                size: new naver.maps.Size(50, 50),
                anchor: new naver.maps.Point(25, 50)
            });
            isMarkerEnlarged = false;
        } else {
            // í˜„ì¬ ì›ë˜ í¬ê¸°ì´ë©´, ë” í° ì‚¬ì´ì¦ˆë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
            infoMarker.setIcon({
                url: './images/prize50.png',
                size: new naver.maps.Size(100, 100), // ì˜ˆ: 1.5ë°° í° ì‚¬ì´ì¦ˆ
                anchor: new naver.maps.Point(25, 50) // ê³ ì •ì ë„ ê·¸ì— ë§ê²Œ ë³€ê²½
            });
            isMarkerEnlarged = true;
        }
    });

//ì¶”ê°€ ë

        }

        function getDistanceInMeters(lat1, lng1, lat2, lng2) {
            function toRad(value) { return value * Math.PI / 180; }
            const R = 6371e3; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë¯¸í„°)
            const dLat = toRad(lat2 - lat1);
            const dLng = toRad(lng2 - lng1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // âœ¨ 3. ìƒíƒœ íŒì—…ì°½ì„ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜
        function showStatusModal(title, text, buttonText, buttonAction = null) {
            document.getElementById('status-modal-title').textContent = title;
            statusModalText.innerHTML = text;
            statusModalBtn.textContent = buttonText;
            
            if (buttonAction) {
                statusModalBtn.style.display = 'inline-block';
                statusModalBtn.onclick = buttonAction;
            } else {
                statusModalBtn.style.display = 'none'; // ë²„íŠ¼ì´ í•„ìš” ì—†ëŠ” ê²½ìš° ìˆ¨ê¹€
            }
        
            statusModal.style.display = 'flex';
            statusModal.style.zindex = '99999';
        }

        statusModalCloseBtn.onclick = () => {
            statusModal.style.display = 'none';
        };

        let lastKnownPosition = null;

        function updateUserLocation() {
            const proximityModal = document.getElementById('modal');

            if (proximityModal.style.display === 'flex' && activeModalId) {
                const loc = stampLocations.find(l => l.id === activeModalId);
                if (loc) {
                    const distance = getDistanceInMeters(lastKnownPosition.lat(), lastKnownPosition.lng(), loc.lat, loc.lng);
            
            // ì‚¬ìš©ìê°€ í•´ë‹¹ ìŠ¤íƒ¬í”„ ì¡´ì—ì„œ 25ë¯¸í„° ì´ìƒ ë²—ì–´ë‚˜ë©´ íŒì—…ì„ ë‹«ìŠµë‹ˆë‹¤.
                    if (distance > 25) {
                        console.log("ì‚¬ìš©ìê°€ íŒì—… ì¡´ì„ ë²—ì–´ë‚˜ì„œ, íŒì—…ì„ ìë™ìœ¼ë¡œ ë‹«ìŠµë‹ˆë‹¤.");
                        closeModal(); // íŒì—…ì„ ë‹«ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
                    }
                }
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const userPosition = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude);

                    if (!map) return; // mapì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
                
                    lastKnownPosition = userPosition;

                    const distance = getDistanceInMeters(userPosition.lat(), userPosition.lng(), eventCenterPoint.lat(), eventCenterPoint.lng());

                    if (distance > eventRadius) {

                        if (!hasShownOutOfBoundsAlert) {
                            alert("ì´ë²¤íŠ¸ ì¥ì†Œì—ì„œ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. í–‰ì‚¬ì¥ìœ¼ë¡œ ì´ë™í•˜ì—¬ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                        // âœ¨ 2. ì•Œë¦¼ì„ í•œë²ˆ ë³´ì—¬ì¤¬ë‹¤ê³  ìƒíƒœë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.
                            hasShownOutOfBoundsAlert = true;
                        }
                        // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ê°€ ìˆë‹¤ë©´ ìˆ¨ê¹ë‹ˆë‹¤.
                        if (userMarker) {
                            userMarker.setMap(null); 
                        }
                        return; // ìŠ¤íƒ¬í”„ ê·¼ì ‘ í™•ì¸ ë¡œì§ì„ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
                    }

                    hasShownOutOfBoundsAlert = false;

                    if (userMarker) {
                        userMarker.setPosition(userPosition);
                        if (userMarker.getMap() === null) {
                            userMarker.setMap(map); // ìˆ¨ê²¨ì ¸ ìˆì—ˆë‹¤ë©´ ë‹¤ì‹œ í‘œì‹œ
                        }
                    } else {
                        userMarker = new naver.maps.Marker({
                            position: userPosition,
                            map: map,
                            title: "ë‚´ ìœ„ì¹˜",
                            icon: {
                                content: [
                                '<div style="text-align: center;">',
                                '    <img src="./images/my_loc_icon.png" alt="ë‚´ ìœ„ì¹˜" ',
                                '         style="width: 40px; height: 40px;">', // ì´ë¯¸ì§€ í¬ê¸°
                                '</div>'
                                ].join(''),
                                anchor: new naver.maps.Point(20, 20) // ì´ë¯¸ì§€ í¬ê¸°ì˜ ì ˆë°˜
                            }
                        });
                    }    
                    checkProximity(userPosition);
                }, () => { alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); });
            }
        }

        function checkProximity(userPosition) {

            if(activeModalId) return; // ëª¨ë‹¬ì´ ì´ë¯¸ ë– ìˆìœ¼ë©´ ì¶”ê°€ í™•ì¸ ì•ˆí•¨

            const proximityLimit = 30; // 20ë¯¸í„°ì—ì„œ 30më¡œ ë³€ê²½
            
            for (const loc of stampLocations) {
                const distance = getDistanceInMeters(userPosition.lat(), userPosition.lng(), loc.lat, loc.lng);
                if (distance <= proximityLimit) {
                    const collectedStamps = JSON.parse(localStorage.getItem('stamps')) || {};

                    const hasStamp = collectedStamps[loc.id];    //9.12 ìˆ˜ì •

 //                   showProximityModal(loc.title, loc.id, hasStamp); //9.12 ìˆ˜ì •
 //                   break;   //9.12 ìˆ˜ì •

                    if (!collectedStamps[loc.id]) {
                        showProximityModal(loc.title, loc.id, hasStamp);
                        break;
                    }
                } 
            }
        }

    //    let activeModalId = null;

        function showProximityModal(title, id, hasStamp) {
            if(activeModalId === id) return;
            activeModalId = id;

            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            
            const modalText = modal.querySelector('span'); // íŒì—…ì°½ì˜ p íƒœê·¸ë¥¼ ì„ íƒ
            const modalStampBtn = document.getElementById('modal-stamp-btn');
            const modalPhotoBtn = document.getElementById('modal-photo-btn');

            modalTitle.textContent = title;
            modal.style.display = 'flex';

            if (hasStamp) {
        // ì´ë¯¸ ìŠ¤íƒ¬í”„ë¥¼ íšë“í•œ ê²½ìš°
//                modalText.innerHTML = "ì´ë¯¸ ìŠ¤íƒ¬í”„ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤." + '<br>' + "í¬í† ì¡´ì„ ì´ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
//                modalStampBtn.style.display = 'none'; // 'ìŠ¤íƒ¬í”„ íˆ¬ì–´ ì°¸ì—¬' ë²„íŠ¼ ìˆ¨ê¸°ê¸°
//                modalPhotoBtn.style.display = 'inline-block'; // 'AR í¬í† ì¡´ ê°€ê¸°' ë²„íŠ¼ì€ ë³´ì´ê²Œ
            } else {
        // ì•„ì§ ìŠ¤íƒ¬í”„ë¥¼ íšë“í•˜ì§€ ì•Šì€ ê²½ìš°
                modalText.textContent = "í–‰ì„±ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤.";
                modalStampBtn.style.display = 'inline-block'; // 'ìŠ¤íƒ¬í”„ íˆ¬ì–´ ì°¸ì—¬' ë²„íŠ¼ ë³´ì´ê¸°
                modalPhotoBtn.style.display = 'inline-block'; // 'AR í¬í† ì¡´ ê°€ê¸°' ë²„íŠ¼ë„ ë³´ì´ê¸°
                modalStampBtn.onclick = () => { window.location.href = `stamptour.html?planet=${id}`; };
                modalPhotoBtn.onclick = () => { window.location.href = `photozone.html?planet=${id}`; };
            }        
        }

        window.onclick = (event) => {
            const modal = document.getElementById('modal');
            if (event.target == modal) {
                modal.style.display = "none";
                activeModalId = null;
            }
        }

    function closeModal() {
        const proximityModal = document.getElementById('modal');
        proximityModal.style.display = 'none';
        activeModalId = null;
    }   

        // í˜ì´ì§€ ë¡œë“œ í›„ 1ì´ˆ ë’¤ë¶€í„° ìœ„ì¹˜ í™•ì¸ ì‹œì‘ (ì§€ë„ ë¡œë”© ì‹œê°„ í™•ë³´)
    setTimeout(() => {
        updateUserLocation();
        setInterval(updateUserLocation, 5000);
    }, 1000);

</script>

</body>
</html>